---
import BaseLayout from '@/components/layout/BaseLayout.astro';
import Footer from '@/components/shared/Footer.astro';
import Navbar from '@/components/shared/Navbar';
import { projects, type Project } from '@/data/projects';
import { ui, defaultLang } from '@/i18n/ui';

export function getStaticPaths() {
  const paths: { 
    params: { lang: string; id: string }; 
    props: { project: Project } 
  }[] = [];
  
  projects.forEach(project => {
    paths.push({ params: { lang: 'es', id: project.id }, props: { project } });
    paths.push({ params: { lang: 'en', id: project.id }, props: { project } });
  });

  return paths;
}

interface Props {
  project: Project;
}

const { lang } = Astro.params;
const { project } = Astro.props;

const t = (key: string) => {
    // @ts-ignore
    return ui[lang]?.[key] || ui[defaultLang][key];
}

const navLabels = {
    home: t('nav.home'),
    about: t('nav.about'),
    skills: t('nav.skills'),
    experience: t('nav.experience'),
    projects: t('nav.projects'),
};

const description = lang === 'es' ? project.description.es : project.description.en;
const challenges = project.challenges ? (lang === 'es' ? project.challenges.es : project.challenges.en) : '';
const learnings = project.learnings ? (lang === 'es' ? project.learnings.es : project.learnings.en) : '';
const features = project.features ? (lang === 'es' ? project.features.es : project.features.en) : [];

const allImages = [project.contentImage, ...(project.gallery || [])];

// --- LÃ“GICA DE NAVEGACIÃ“N ENTRE PROYECTOS ---
const currentIndex = projects.findIndex(p => p.id === project.id);
const prevProject = projects[currentIndex === 0 ? projects.length - 1 : currentIndex - 1];
const nextProject = projects[currentIndex === projects.length - 1 ? 0 : currentIndex + 1];
---

<BaseLayout title={`${project.title} | Juanpe Portfolio`} lang={lang}>
    
    <Navbar client:load lang={lang} labels={navLabels} />

    {/* DATA STORAGE: Guardar datos en el DOM para lectura directa */}
    <div id="gallery-data" 
         data-images={JSON.stringify(allImages.map(img => img.src))}
         data-project-id={project.id}
         class="hidden">
    </div>

    <main class="flex-1 w-full max-w-[1800px] mx-auto px-4 py-6 flex flex-col lg:h-[calc(100vh-80px)] lg:overflow-hidden" transition:animate="fade">
        
        <div class="mb-4 flex-shrink-0">
            <a href={`/${lang}#projects`} class="text-sm text-slate-400 hover:text-blue-400 transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                {lang === 'es' ? 'Volver' : 'Back'}
            </a>
        </div>

        <div class="flex flex-col lg:grid lg:grid-cols-12 gap-8 h-full lg:overflow-hidden pb-4">
            
            <div class="lg:col-span-7 flex flex-col h-auto lg:h-full gap-4 min-h-0">
                
                <div class="flex-shrink-0">
                    <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">{project.title}</h1>
                    <div class="flex flex-wrap gap-2">
                        {project.tags.map((tag: string) => (
                            <span class="px-2 py-0.5 bg-blue-900/20 text-blue-300 rounded text-xs font-semibold border border-blue-800">
                                {tag}
                            </span>
                        ))}
                    </div>
                </div>

                {/* AÃ±adimos touch-action-pan-y para mejorar el comportamiento en mÃ³vil */}
                <div class="relative aspect-video lg:flex-1 lg:aspect-auto rounded-xl overflow-hidden border border-slate-800 bg-black group touch-pan-y" id="zoom-container">
                    
                    {/* Imagen Principal - key Ãºnico por proyecto */}
                    <img 
                        id="main-display"
                        src={allImages[0].src} 
                        alt={project.title}
                        data-project-id={project.id}
                        class="w-full h-full object-contain transition-opacity duration-300 cursor-zoom-in" 
                    />
                    
                    {/* BotÃ³n Anterior - Visible en mÃ³vil */}
                    <button id="prev-btn" class="absolute left-2 md:left-4 top-1/2 -translate-y-1/2 p-2 md:p-3 rounded-full bg-black/70 text-white/90 hover:text-white hover:bg-blue-600 transition-all opacity-100 md:opacity-0 md:group-hover:opacity-100 z-20 focus:outline-none focus:opacity-100">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    
                    {/* BotÃ³n Siguiente - Visible en mÃ³vil */}
                    <button id="next-btn" class="absolute right-2 md:right-4 top-1/2 -translate-y-1/2 p-2 md:p-3 rounded-full bg-black/70 text-white/90 hover:text-white hover:bg-blue-600 transition-all opacity-100 md:opacity-0 md:group-hover:opacity-100 z-20 focus:outline-none focus:opacity-100">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>

                {/* Miniaturas */}
                <div class="h-16 lg:h-20 flex gap-2 overflow-x-auto pb-1 scrollbar-hide flex-shrink-0" id="thumbnails-container">
                    {allImages.map((img, index) => (
                        <button 
                            class="thumb-btn relative w-24 lg:w-28 h-full rounded-lg overflow-hidden border-2 cursor-pointer flex-shrink-0 transition-all border-transparent opacity-60 hover:opacity-100"
                            data-index={index}
                        >
                            <img src={img.src} alt={`${project.title} - imagen ${index + 1}`} class="w-full h-full object-cover" />
                        </button>
                    ))}
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col h-auto lg:h-full lg:overflow-hidden glass rounded-2xl border border-slate-800/50 bg-slate-900/50">
                
                <div class="p-6 pb-4 flex flex-wrap justify-start lg:justify-end gap-4 border-b border-slate-800/50 bg-slate-900/50 backdrop-blur-md flex-shrink-0 sticky top-0 lg:relative z-10">
                    {project.link && (
                        <a href={project.link} target="_blank" class="text-sm font-semibold text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            Web
                        </a>
                    )}
                    {project.repo && (
                        <a href={project.repo} target="_blank" class="text-sm font-semibold text-slate-400 hover:text-white flex items-center gap-1 transition-colors">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                            GitHub {project.repoBack ? '(Front)' : ''}
                        </a>
                    )}
                    {project.repoBack && (
                        <a href={project.repoBack} target="_blank" class="text-sm font-semibold text-slate-400 hover:text-white flex items-center gap-1 transition-colors">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                            GitHub (Back)
                        </a>
                    )}
                </div>

                <div class="p-6 pt-0 lg:overflow-y-auto space-y-8 flex-1 custom-scroll">
                    
                    <div>
                        <h3 class="text-lg font-bold text-white mb-2">DescripciÃ³n</h3>
                        <p class="text-slate-300 leading-relaxed text-sm">
                            {description}
                        </p>
                    </div>

                    {features.length > 0 && (
                        <div>
                            <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                                <span class="text-blue-500">âš¡</span> Funcionalidades
                            </h3>
                            <ul class="grid grid-cols-1 gap-2">
                                {features.map((feat: string) => (
                                    <li class="flex items-start gap-2 text-sm text-slate-400">
                                        <svg class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        <span>{feat}</span>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}

                    {challenges && (
                        <div>
                            <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                                <span class="text-red-500">ðŸ”¥</span> Retos y Soluciones
                            </h3>
                            <div class="text-sm text-slate-300 bg-red-900/10 border border-red-900/30 p-4 rounded-lg">
                                {challenges}
                            </div>
                        </div>
                    )}

                    {learnings && (
                        <div>
                            <h3 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                                <span class="text-green-500">ðŸ’¡</span> Aprendizajes
                            </h3>
                            <div class="text-sm text-slate-300 bg-green-900/10 border border-green-900/30 p-4 rounded-lg">
                                {learnings}
                            </div>
                        </div>
                    )}

                    <div class="border-t border-slate-800 pt-6 mt-8">
                        <div class="flex items-center justify-between gap-4">
                            
                            <a href={`/${lang}/projects/${prevProject.id}`} class="group flex flex-col items-start gap-1 text-left flex-1 hover:bg-slate-800/50 p-2 rounded-lg transition-colors">
                                <span class="text-xs text-slate-400 uppercase tracking-wider font-semibold flex items-center gap-1 group-hover:text-blue-500 transition-colors">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                                    {t('project.prev')}
                                </span>
                                <span class="text-sm font-bold text-slate-200 line-clamp-1">
                                    {prevProject.title}
                                </span>
                            </a>

                            <div class="w-px h-8 bg-slate-800 hidden md:block"></div>

                            <a href={`/${lang}/projects/${nextProject.id}`} class="group flex flex-col items-end gap-1 text-right flex-1 hover:bg-slate-800/50 p-2 rounded-lg transition-colors">
                                <span class="text-xs text-slate-400 uppercase tracking-wider font-semibold flex items-center gap-1 group-hover:text-blue-500 transition-colors">
                                    {t('project.next')}
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                </span>
                                <span class="text-sm font-bold text-slate-200 line-clamp-1">
                                    {nextProject.title}
                                </span>
                            </a>

                        </div>
                    </div>

                </div>
            </div>
        </div>

        {/* Lightbox - Optimizado para Safari mÃ³vil */}
        <div id="lightbox" class="fixed inset-0 z-[9999] bg-black/95 hidden items-center justify-center p-4 opacity-0 transition-opacity duration-300 backdrop-blur-sm select-none touch-none">
            <button id="close-lightbox" class="absolute top-6 right-6 text-white/70 hover:text-white p-2 transition-colors bg-black/50 rounded-full z-[10000]">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <button id="lightbox-prev" class="absolute left-4 md:left-8 top-1/2 -translate-y-1/2 p-3 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition-all z-[10000]">
                <svg class="w-8 h-8 md:w-10 md:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <img id="lightbox-img" src="" alt="Vista ampliada" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl transition-transform duration-300" />
            <button id="lightbox-next" class="absolute right-4 md:right-8 top-1/2 -translate-y-1/2 p-3 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition-all z-[10000]">
                <svg class="w-8 h-8 md:w-10 md:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>

        <Footer t={t} lang={lang} />

    </main>

    <script>
        // ðŸ”¥ SOLUCIÃ“N DEFINITIVA: Leer datos directamente del DOM
        
        let galleryCleanup: (() => void) | null = null;

        function initGallery() {
            console.log('ðŸš€ Iniciando galerÃ­a...');

            // Limpiar instancia anterior
            if (galleryCleanup) {
                console.log('ðŸ§¹ Limpiando galerÃ­a anterior');
                galleryCleanup();
            }

            // 1ï¸âƒ£ LEER DATOS DEL DOM (NO de define:vars)
            const galleryData = document.getElementById('gallery-data');
            if (!galleryData) {
                console.error('âŒ No se encontrÃ³ gallery-data');
                return;
            }

            const images = JSON.parse(galleryData.dataset.images || '[]');
            const projectId = galleryData.dataset.projectId;

            console.log(`ðŸ“¦ Proyecto: ${projectId}, ImÃ¡genes: ${images.length}`);

            if (images.length === 0) {
                console.warn('âš ï¸ No hay imÃ¡genes para mostrar');
                return;
            }

            let currentIndex = 0;
            
            // 2ï¸âƒ£ REFERENCIAS AL DOM
            const display = document.getElementById('main-display') as HTMLImageElement | null;
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement | null;
            const thumbs = document.querySelectorAll('.thumb-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const lightboxPrev = document.getElementById('lightbox-prev');
            const lightboxNext = document.getElementById('lightbox-next');
            const zoomContainer = document.getElementById('zoom-container');
            const closeLightbox = document.getElementById('close-lightbox');

            // 3ï¸âƒ£ RESETEAR TODAS LAS IMÃGENES INMEDIATAMENTE
            console.log('ðŸ–¼ï¸ Cargando imÃ¡genes...');
            
            if (display) {
                // Forzar limpieza y recarga
                display.style.opacity = '0';
                display.src = '';
                setTimeout(() => {
                    display.src = images[0];
                    display.style.opacity = '1';
                    display.dataset.projectId = projectId;
                }, 50);
            }

            if (lightboxImg) {
                lightboxImg.src = images[0];
            }

            // Actualizar miniaturas
            thumbs.forEach((btn, i) => {
                const img = btn.querySelector('img');
                if (img && images[i]) {
                    img.src = images[i];
                }
            });

            // 4ï¸âƒ£ FUNCIONES DE LA GALERÃA
            function updateAllViews(index: number) {
                currentIndex = index;
                
                if (display) {
                    display.style.opacity = '0.5';
                    setTimeout(() => {
                        display.src = images[currentIndex];
                        display.style.opacity = '1';
                    }, 150);
                }

                if (lightboxImg) {
                    lightboxImg.src = images[currentIndex];
                }

                thumbs.forEach((t, i) => {
                    if(i === currentIndex) {
                        t.classList.add('border-blue-500', 'opacity-100');
                        t.classList.remove('border-transparent', 'opacity-60');
                        t.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    } else {
                        t.classList.remove('border-blue-500', 'opacity-100');
                        t.classList.add('border-transparent', 'opacity-60');
                    }
                });
            }

            function navigate(direction: number) {
                let newIndex = currentIndex + direction;
                if (newIndex < 0) newIndex = images.length - 1;
                if (newIndex >= images.length) newIndex = 0;
                updateAllViews(newIndex);
            }

            // 5ï¸âƒ£ BIS - GESTOS TÃCTILES (SWIPE)
            // Variables para almacenar las coordenadas del toque
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            const minSwipeDistance = 50; // Distancia mÃ­nima en pÃ­xeles para considerar un swipe

            const onTouchStart = (e: TouchEvent) => {
                // Guardamos donde empieza el toque
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            };

            const onTouchEnd = (e: TouchEvent) => {
                // Guardamos donde termina el toque (changedTouches porque el toque ya no estÃ¡ activo)
                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;
                detectSwipe();
            };

            const detectSwipe = () => {
                const diffX = touchEndX - touchStartX;
                const diffY = touchEndY - touchStartY;

                // Comprobamos si el movimiento es mÃ¡s horizontal que vertical
                // Esto evita que se active el swipe cuando el usuario hace scroll en la pÃ¡gina
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    // Si la distancia supera el umbral mÃ­nimo
                    if (Math.abs(diffX) > minSwipeDistance) {
                        if (diffX > 0) {
                            // Swipe a la derecha -> Imagen anterior
                            navigate(-1);
                        } else {
                            // Swipe a la izquierda -> Imagen siguiente
                            navigate(1);
                        }
                    }
                }
            }


            // 6ï¸âƒ£ EVENT HANDLERS
            const handlePrevClick = (e: Event) => { 
                e.stopPropagation(); 
                navigate(-1); 
            };

            const handleNextClick = (e: Event) => { 
                e.stopPropagation(); 
                navigate(1); 
            };

            const handleZoomClick = (e: Event) => {
                // Si el click proviene de los botones de navegaciÃ³n, no hacemos zoom
                if ((e.target as HTMLElement).closest('button')) return;
                
                if(lightboxImg) lightboxImg.src = images[currentIndex];
                lightbox?.classList.remove('hidden');
                lightbox?.classList.add('flex');
                requestAnimationFrame(() => {
                    lightbox?.classList.remove('opacity-0');
                    document.body.style.overflow = 'hidden';
                });
            };

            const closeBox = () => {
                lightbox?.classList.add('opacity-0');
                setTimeout(() => {
                    lightbox?.classList.add('hidden');
                    lightbox?.classList.remove('flex');
                    document.body.style.overflow = '';
                }, 300);
            };

            const handleThumbClick = (e: Event) => {
                const btn = e.currentTarget as HTMLElement;
                const index = parseInt(btn.getAttribute('data-index') || '0');
                updateAllViews(index);
            };

            const handleKeyDown = (e: KeyboardEvent) => {
                if (e.key === 'Escape') closeBox();
                if (e.key === 'ArrowLeft') navigate(-1);
                if (e.key === 'ArrowRight') navigate(1);
            };

            const handleLightboxBgClick = (e: Event) => {
                if(e.target === lightbox) closeBox();
            };

            // 7ï¸âƒ£ ASIGNAR EVENTOS
            prevBtn?.addEventListener('click', handlePrevClick as EventListener);
            nextBtn?.addEventListener('click', handleNextClick as EventListener);
            
            // Eventos para el contenedor principal (Zoom click y Swipe touch)
            zoomContainer?.addEventListener('click', handleZoomClick as EventListener);
            zoomContainer?.addEventListener('touchstart', onTouchStart as EventListener, { passive: true });
            zoomContainer?.addEventListener('touchend', onTouchEnd as EventListener);

            // Eventos para el LIGHTBOX (Swipe touch) - AÃ‘ADIDO AQUÃ
            lightbox?.addEventListener('touchstart', onTouchStart as EventListener, { passive: true });
            lightbox?.addEventListener('touchend', onTouchEnd as EventListener);


            closeLightbox?.addEventListener('click', closeBox);
            lightboxPrev?.addEventListener('click', ((e: Event) => { e.stopPropagation(); navigate(-1); }) as EventListener);
            lightboxNext?.addEventListener('click', ((e: Event) => { e.stopPropagation(); navigate(1); }) as EventListener);
            lightbox?.addEventListener('click', handleLightboxBgClick as EventListener);
            document.addEventListener('keydown', handleKeyDown);

            thumbs.forEach(btn => {
                btn.addEventListener('click', handleThumbClick as EventListener);
            });

            // Inicializar primera miniatura
            updateAllViews(0);

            console.log('âœ… GalerÃ­a inicializada correctamente');

            // 8ï¸âƒ£ FUNCIÃ“N DE LIMPIEZA
            galleryCleanup = () => {
                console.log('ðŸ§¹ Ejecutando cleanup...');
                prevBtn?.removeEventListener('click', handlePrevClick as EventListener);
                nextBtn?.removeEventListener('click', handleNextClick as EventListener);
                
                // Limpiamos eventos del contenedor principal
                zoomContainer?.removeEventListener('click', handleZoomClick as EventListener);
                zoomContainer?.removeEventListener('touchstart', onTouchStart as EventListener);
                zoomContainer?.removeEventListener('touchend', onTouchEnd as EventListener);

                // Limpiamos eventos del LIGHTBOX - AÃ‘ADIDO AQUÃ
                lightbox?.removeEventListener('touchstart', onTouchStart as EventListener);
                lightbox?.removeEventListener('touchend', onTouchEnd as EventListener);


                closeLightbox?.removeEventListener('click', closeBox);
                lightbox?.removeEventListener('click', handleLightboxBgClick as EventListener);
                document.removeEventListener('keydown', handleKeyDown);
                thumbs.forEach(btn => {
                    btn.removeEventListener('click', handleThumbClick as EventListener);
                });
                document.body.style.overflow = '';
                
                // Limpiar imÃ¡genes del DOM
                if (display) display.src = '';
                if (lightboxImg) lightboxImg.src = '';
            };
        }

        // 9ï¸âƒ£ EVENTOS DEL CICLO DE VIDA DE ASTRO
        
        // Primera carga
        initGallery();
        
        // DespuÃ©s de cada transiciÃ³n (CRÃTICO)
        document.addEventListener('astro:after-swap', () => {
            console.log('ðŸ”„ Astro: after-swap - Esperando DOM...');
            // Esperar a que el DOM estÃ© completamente actualizado
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    initGallery();
                });
            });
        });
        
        // Antes de salir de la pÃ¡gina
        document.addEventListener('astro:before-preparation', () => {
            console.log('ðŸ‘‹ Astro: before-preparation - Limpiando...');
            if (galleryCleanup) {
                galleryCleanup();
            }
        });

        // Cuando la pÃ¡gina se carga completamente
        document.addEventListener('astro:page-load', () => {
            console.log('ðŸ“„ Astro: page-load');
            initGallery();
        });
    </script>

</BaseLayout>